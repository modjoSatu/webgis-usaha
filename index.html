<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WebGIS Direktori Usaha (PWA)</title>

  <!-- Base path agar semua resource relatif -->
  <base href="./">

  <!-- Styles & manifest -->
  <link rel="stylesheet" href="./css/style.css" />
  <link rel="manifest" href="./manifest.json" />
  <meta name="theme-color" content="#2196f3" />

  <!-- Leaflet & PapaParse -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
</head>

<body>
  <!-- ====== ISI UTAMA DARI APLIKASI WEBGIS KAMU ====== -->
  <div id="app">
    <h2>WebGIS Direktori Usaha (PWA)</h2>
    <p>Jika halaman ini menampilkan pesan di console, autoload bekerja.</p>
    <div id="map" style="height: 70vh;"></div>
  </div>
  <!-- ================================================= -->

  <!-- File JS utama -->
  <script src="./js/utils.js"></script>
  <script src="./js/layers.js"></script>
  <script src="./js/main.js"></script>

  <!-- Service Worker + AutoLoad fallback -->
  <script>
  // Daftarkan Service Worker (jalur relatif penting untuk GitHub Pages)
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./service-worker.js')
      .then(() => {
        console.log('Service Worker registered.');
        // coba panggil autoLoadAll() jika tersedia
        if (typeof autoLoadAll === 'function') {
          console.log('Auto-loading layers (if reachable)...');
          setTimeout(autoLoadAll, 500);
        } else {
          console.warn('autoLoadAll() belum terdefinisi.');
        }
      })
      .catch(err => console.warn('SW register failed', err));
  }

  // Jika file main.js belum ada, definisikan fallback autoLoadAll sederhana
  if (typeof autoLoadAll === 'undefined') {
    async function autoLoadAll() {
      console.log('[Fallback] Auto-loading test fetch...');
      const sources = [
        { name: 'SLS', url: 'https://drive.bps.go.id/s/J4zmooj62jtjxrZ/download' },
        { name: 'PLKUMKM', url: 'https://drive.bps.go.id/s/5YW2mN8siwLEFsB/download' },
        { name: 'Matchapro', url: 'https://drive.bps.go.id/s/LqSFxXeLfFYpbCG/download' },
        { name: 'SWMAPS', url: 'https://drive.bps.go.id/s/zAYXQd4dir4RKRA/download' },
        { name: 'KDM', url: 'https://drive.bps.go.id/s/TrR9AmXe7z9KciJ/download' }
      ];
      for (const src of sources) {
        try {
          const res = await fetch(src.url);
          const text = await res.text();
          console.log(`✅ ${src.name} loaded (${(text.length/1024/1024).toFixed(2)} MB)`);
        } catch (err) {
          console.warn(`⚠️ ${src.name} failed:`, err);
        }
      }
    }
  }
  </script>
</body>
</html>
